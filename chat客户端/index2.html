<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0" />  
<meta name="apple-mobile-web-app-capable" content="yes" />  
<meta name="format-detection" content="telephone=no" />  
<link rel="stylesheet" href="css/style.css" media="screen" type="text/css" />
</head>
<body>
<div class="doc" id="app">
      <div id="convo" class="chatwind" data-from="Sonu Joshi">  
        <ul class="chat-thread" ref="scorll" id="scorll">
            <li  v-for="(chat,index) in chatinfo" ref="uli" v-bind:class="chat.me == config.me ? 'me' : 'you'"><i> 
            <img v-if="chat.me == config.me" :src="myinfo.face" width="50"   />
            <img v-else :src="yourinfo.face" width="50"   />
             </i>{{chat.msg}}
       
             
            </li>
            
        </ul>
       <div class="forms" ref="forms"> 
       <p class="line">
       <textarea v-model="message" :name="message" class="message" @input="textFunc" id="Jmassage" placeholder="Enter your message" required="" ></textarea> <input type="button" class="sub" name="submit" value="发送" @click="sendMassage" @keyup.13="sendMassage" />
       </p>
       <p class="line">
      <label>你的昵称：</label> <input type="text" name=""  v-model="config.me" @input="inputFunc" name="user"  class="text" /> <!--  vm.$set( vm.config,"me",vm.config.me ) -->
      </p>
      <p class="line">
       <label>你要发给谁：</label><input type="text" name=""  v-model="config.to" name="friends" @input="inputFunc" class="text" />
        </p>
       </div>
    </div>
</div>
    <script type="text/javascript" src="vue.min.js"></script>
     <script  src="http://192.168.33.233:8080/socket.io/socket.io.js" type=></script>
    <script>
var vm = new Vue({
  el: '#app',
  data: {

    config: {
      url: "ws://192.168.33.233:8080",
      server: "personWS",
      me: "god",
      to: "daxiong",

    },
    myinfo: [{
      username: "",
      face: "",
      nichen: ""
    }],
    //先设置控制，防止阻塞报错
    yourinfo: [{
      username: "",
      face: "",
      nichen: ""
    }],
    chatinfo: [],
    message: "",
    history: 20
  },
  created: function() {
    var _this = this;
     socket = io.connect(_this.config.url); //创建一个ws链接
    _this.$options.methods.upconfig(_this);//获取用户配置

    _this.$options.methods.getHistory(_this); //请求历史消息
  
    _this.$options.methods.resend(socket, _this.config.me, function(data) {//实时聊天
      _this.chatinfo.push(data)
    });

    _this.$options.methods.resend(socket,"input"+"_"+_this.config.me, function(data) {//实时聊天
      if(data==1){
        document.title=""+_this.yourinfo.nichen+"正在输入......";   
      }else{
             document.title="正在和"+_that.yourinfo.nichen+"聊天";
      }
    });
 
  },
  methods:
   {
    textFunc:function(){
      var _this = this,go=false;
        _this.send(socket, "input", [_this.config.to,1]);
         setTimeout(function () {
      
          _this.send(socket, "input", [_this.config.to,0]);

            },350)

       
    },inputFunc:function(){
      var _this = this;
       _this.upconfig(_this);
       
    },
    upconfig:function(obj){
      // 必须要把运行该函数的 this指向传入， 不然指向当前的this 会被报空值
      var _this=this;
      _that=obj;

     var data = {
        me: obj.config.me,
        to: obj.config.to,
      };

      _this.send(socket, "userInfo", data);
      _that.resend(socket, "userInfo"+"_"+obj.config.me, function(data) { //监听历史数据返回
      //聊天用户配置   _this.config.myface=  

       _that.getuserinfo(_that.config.me, data, function(info) {
        _that.myinfo = info; //指向 

  
      });
      _that.getuserinfo(_that.config.to, data, function(info) {
        _that.yourinfo = info;
 
      });
    document.title="正在和"+_that.yourinfo.nichen+"聊天"; //vue2 

    });

 
   },
    getHistory: function(obj) {
     var  _this = this;
      var data = {
        server: "getHistory",
        me: obj.config.me,
        to: obj.config.to,
        count: obj.history
      };
      obj.$options.methods.send(socket, "getHistory", data);
        obj.$options.methods.resend(socket, "resHistory"+"_"+obj.config.me, function(data) { //监听历史数据返回
          //获取聊天记录
          obj.chatinfo = data;

        });

    },
    sendMassage: function(event) {
      if (this.message == "") alert("你还没有输入信息");
      if ((event.keyCode == 13 || event.type == "click") && this.message != "") {
        var data = {
          server: this.config.server,
          me: this.config.me,
          to: this.config.to,
          msg: this.message
        };
        var server = this.config.server;
        this.$options.methods.send(socket, server, data);
        this.message = "";
      }


    },
    send: function(obj, mark, data) {
      //console.log(data)
      obj.emit(mark, data);
    },
    resend: function(obj, mark, fn) {

      obj.on(mark, function(data) {
        // console.log(data)
        return fn && fn(data);

      });
    },
    getuserinfo: function(username, data, fn) {
      //这个函数只是返回某一个用户配置数组
      for (var i = 0; i < data.length; i++) {

        if (data[i].username == username) {

          fn && fn(data[i]);



        }
      }



    }

  }
 })


 
 vm.$watch("chatinfo", function() { 
  var h = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
  vm.$refs.scorll.style.height = h * 0.6 + "px";
  vm.$refs.forms.style.height = h * 0.34 + "px"; //放在这个里表示获取聊天的时候 vm已经创建， 相当 JQ 的 ready

  vm.$refs.scorll.scrollTop = vm.$refs.scorll.scrollHeight; //滚动聊天

   
  //console.log(vm.userInfo)
 })
 
 
 

    </script>
</body>
</html>